**代码在持续修改，见修改说明**

这是一个实习任务，历时8天（终于） ~~完成~~ 结束，是对元气骑士一小部分内容的模仿。

下面没有列出来的内容就是没有实现的。

# 游戏内容

## UI

1. 开始菜单：开始游戏和结束游戏的按钮。
2. 暂停菜单：退出和继续按钮，调节总音量、音乐音量、音效音量的滑动条。
3. 血量、护甲、能量和金币显示。
4. 一些对话框。

## 地图[map]

时间不足，只绘制了1-1和1-2。进入1-2的传送门后会直接回到开始菜单。

1. 地板、墙、门、传送门：预先绘制好的tilemap（使用了 *rule tile* 的随机输出）。
2. 房间[room]:控制自动开关门，刷新怪物[enemy] 、木箱[box] 和宝箱 [日  takarabox]。

## 玩家[player]

实现移动、瞄准、捡武器、切换主副手、加速。进入下一关时保留数据。

## 武器[weapon]

只实现了六种武器，开始时即持有两把武器。每种武器对应一种子弹[bullet]。

## 敌人[enemy]

只实现了五种敌人。敌人的碰撞体比看起来小，请瞄准中心射。将要被包围时，冲出去并跑远一点比所在角落里更好。有的敌人会发射弹幕[日  danmaku]。

## 收集物[collection]

木箱和敌人掉落能量点[energypoint]和金币[coinpoint]，宝箱50%掉落能量点和金币，50%掉落武器。

所以说没有实现其他各种房间，地图上有几个未完成的空房间。还没有花钱、回血的手段。

# 实现的要求

1. 最低要求。
2. 1-1和1-2，只实现了生成怪物的房间。
3. 几种敌人，随机生成敌人和木箱。
4. 几种武器，切换和拾取武器。
5. UI。
6. 能量和金币。
7. 生成宝箱。

# 程序架构

空对象*scenemanager*上的脚本*scene*里是常用工具函数和场景切换函数。

地图是预设的，剩下的GameObject几乎都做成了prefab，所以找什么都去prefab文件夹。需要频繁生成的GameObject都放在空对象*asset*里，以供查找并克隆。基本上依据名字查找GameObject和Component，而不是用“拖动”实现。

**很简单的内容就不详细讲了。**

## UI和音频

和按钮、文本框、混音器等等交互，很简单。部分在*menu*脚本，部分在*player*脚本。控制音频的程序分散在各种脚本里。

## 玩家

见*player*脚本。

1. 移动：很简单。

2. 技能：两个float记录技能冷却和技能持续时间（是常量，不是计时器）两个bool记录技能是否在生效、在冷却，并通过两个Invoke方法控制技能持续时间和冷却时间。武器射击时调用*player*里的相关方法获知是否要生成两次子弹。

3. 血量和护甲：接触有接触伤害的敌人或被弹幕时击中时调用相应的函数。两个计时器来记录无敌时间（受到伤害后1s内不再受伤）和下次护甲回复的时间。加速效果的实现也类似。
4. 能量和金币：能量点和金币接触玩家后调用*player*里相应的函数，武器射击时也会调用。
5. 切武器：激活一个武器，禁用另一个武器即可。
6. 进入下一关时数据保留：没有移动或保留GameObject，而是用PlayerPref记录并读取数据。武器也是读取完数据再生成的。音量设定也会保留，但每次启动游戏时会重置。

## 武器

*weapon*是所有武器的父类。

1. 捡武器：bool记录武器是否被捡起，未被捡起时依靠触发器实现拾取，被拾取后各种方法才会生效，同时关闭触发器。
2. 跟随玩家和瞄准：以自身、玩家的transform和鼠标的position 确定武器transform的各属性。
3. 射击：以计时器实现射击冷却。感觉在update检测射击不够灵敏，以InvokeReapeting方法调用射击函数。依据武器的位置、瞄准方向、弹道、形状来确定子弹射出位置（包括对武器的偏移量）、方向和旋转。还实现了子弹射出时随机偏转一定角度（float记录最大偏转幅度）。
4. 弓：实现弓的时候碰到很多困难。弓射击的过程比较复杂，分拉紧、释放、冷却三个阶段，阶段控制和玩家技能的实现差不多，具体看代码。弓的图片素材和其他武器的朝向不一样，要把弓放到一个自带旋转的空父物体上，这样才不会影响*weapon*的代码，但这又使得在*asset*里查找并克隆弓时要作特殊处理。而且蓄力时弓上要出现一支箭，于是蓄力时就要生成一个*bullet*，像武器一样跟随玩家并旋转，为了少作方法重写，这个*bullet*在释放弓弦时被销毁，而原本生成*bullet*的方法不变。另外，弓的伤害取决于蓄力时间，所以还会额外调用*bullet*上的一个方法。

## 子弹

*bullet*是所有子弹的父类。

1. 造成伤害：依靠触发器，目标是带“Enemy”标签的GameObject，很简单。
2. 暴击：子弹被生成时调用*player*上的相关方法获知是否会暴击。
3. 穿透：bool记录是否有穿透性，有穿透性则不会在接触某些碰撞体时自毁。 

## 敌人

*enemy*是所有敌人的父类。

1. 行动逻辑：玩家到敌人的距离决定了敌人是否处于战斗状态，非战斗状态下大多会每隔一段时间随机地移动一次，战斗状态下大多会每隔一段时间向玩家移动一次，这和实现玩家的技能差不多。某些怪物还会在每次行动中的某个时机发射弹幕，所以还要一个计时器。每个敌人被激活时还会随机休眠一会，以免行动节奏重合。
2. 动画：只做了简单的动画，而且没找到完整的一套带武器的动画图。。。放死亡动画时GameObject还在，要禁用一些组件。

## 弹幕

*danmaku*是所有弹幕的父类。

和*bullet*几乎一样，只是目标变成了带“Player”标签的GameObject。

## 房间

见*room*脚本。每个会刷怪的房间都有一份这个脚本，没时间把每个房间调得不一样了。

1. 生成敌人木箱宝箱：每个房间被划分为225块（外围一圈不生成物体），所以只有169个点可以生成物体，这样能对齐到网格并避免重叠。且虽然敌人有多种，但名字只差一个数字。这样随机ID和随机位置都很容易实现。（游戏加载时就生成好所有东西，只是不激活）
2. 开关门：进有怪的房间就关门，刚进房间1s内不会受到伤害（敌人也在休眠）。每个房间有一个怪物计数器，怪物死亡时使所属房间的计数器减小，计数器到0时开门，并激活宝箱。之后摧毁自身。

## 宝箱

见*takarabox*脚本。

一定几率掉金币和能量点，一定几率掉随机武器，武器的名字也只差一个数字，所以和生成怪物一样。玩家接触宝箱就摧毁宝箱并生成金币和能量点或激活已经生成好的武器。

## 金币和能量点

见*energypoint*和*coinpoint*脚本。

生成时休眠1秒，检测到玩家接近到一定距离后会向玩家移动，检测频率不用很高。用InvokeRepeating方法。

# 使用的插件和包

元气骑士的资源包里只使用了图片

*rule tile*

*textMesh Pro* (这个是包吗？)

*cinemachine*

